<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - used things-Tz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(145deg, #f6f9fc, #e6f0f5);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo span {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 50px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
        }

        .main-content {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .notifications-header h1 {
            font-size: 2rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mark-all-read {
            padding: 12px 25px;
            background: white;
            border: 2px solid #ff6b6b;
            border-radius: 50px;
            color: #ff6b6b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mark-all-read:hover {
            background: #ff6b6b;
            color: white;
        }

        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .notification-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .notification-card:hover {
            transform: translateY(-3px);
            border-color: #ff6b6b;
            box-shadow: 0 10px 30px rgba(255,107,107,0.1);
        }

        .notification-card.unread {
            background: rgba(255,107,107,0.05);
            border-left: 4px solid #ff6b6b;
        }

        .notification-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .notification-time {
            color: #999;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .notification-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notification-btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
        }

        .notification-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
        }

        .empty-state i {
            font-size: 60px;
            color: #ccc;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #666;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 15px 20px;
            }

            .nav-container {
                flex-direction: column;
                gap: 15px;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .notifications-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .notification-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .notification-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="user-dashboard.html" class="logo">
                <i class="fas fa-store"></i>
                <span>used things-Tz</span>
            </a>
            <div class="nav-links">
                <a href="user-dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="favorites.html" class="nav-link">
                    <i class="fas fa-heart"></i> Favorites
                </a>
                <a href="notifications.html" class="nav-link active">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <a href="profile.html" class="nav-link">
                    <i class="fas fa-user"></i> Profile
                </a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="notifications-header">
            <h1>
                <i class="fas fa-bell" style="color: #ff6b6b;"></i>
                Notifications
            </h1>
            <button class="mark-all-read" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i>
                Mark all as read
            </button>
        </div>

        <div id="notificationsList" class="notifications-list">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <script type="module">
        import { notifications, supabase } from './js/supabase-config.js';

        let currentUser = null;

        async function loadNotifications() {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                window.location.href = 'signin.html';
                return;
            }

            const result = await notifications.getUserNotifications(currentUser.id);
            
            if (result.success) {
                displayNotifications(result.data);
            }
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');

            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No notifications</h3>
                        <p>You're all caught up!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(notification => `
                <div class="notification-card ${notification.is_read ? '' : 'unread'}" id="notification-${notification.id}">
                    <div class="notification-icon">
                        ${getNotificationIcon(notification.type)}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">
                            ${notification.title}
                            ${!notification.is_read ? '<span style="color: #ff6b6b; font-size: 12px;">New</span>' : ''}
                        </div>
                        <div class="notification-message">
                            ${notification.message}
                        </div>
                        <div class="notification-time">
                            <i class="fas fa-clock"></i>
                            ${getTimeAgo(notification.created_at)}
                        </div>
                        <div class="notification-actions">
                            ${getNotificationActions(notification)}
                            ${!notification.is_read ? `
                                <button class="notification-btn secondary" onclick="markAsRead('${notification.id}')">
                                    <i class="fas fa-check"></i>
                                    Mark read
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getNotificationIcon(type) {
            const icons = {
                'new_message': 'fa-comment',
                'new_product': 'fa-box',
                'favorite': 'fa-heart',
                'price_drop': 'fa-tag',
                'sold': 'fa-check-circle',
                'review': 'fa-star'
            };
            return `<i class="fas ${icons[type] || 'fa-bell'}"></i>`;
        }

        function getNotificationActions(notification) {
            const actions = {
                'new_message': `
                    <button class="notification-btn primary" onclick="window.location.href='chat.html?conversation=${notification.data?.conversation_id}'">
                        <i class="fas fa-comment"></i>
                        View message
                    </button>
                `,
                'new_product': `
                    <button class="notification-btn primary" onclick="window.location.href='product.html?id=${notification.data?.product_id}'">
                        <i class="fas fa-eye"></i>
                        View product
                    </button>
                `
            };
            return actions[notification.type] || '';
        }

        window.markAsRead = async function(notificationId) {
            const result = await notifications.markAsRead(notificationId);
            if (result.success) {
                const element = document.getElementById(`notification-${notificationId}`);
                element.classList.remove('unread');
                element.querySelector('.notification-title span')?.remove();
            }
        };

        window.markAllAsRead = async function() {
            if (!currentUser) return;
            const result = await notifications.markAllAsRead(currentUser.id);
            if (result.success) {
                document.querySelectorAll('.notification-card.unread').forEach(el => {
                    el.classList.remove('unread');
                    el.querySelector('.notification-title span')?.remove();
                });
            }
        };

        function getTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // Subscribe to real-time notifications
        function subscribeToNotifications() {
            if (!currentUser) return;

            const subscription = supabase
                .channel(`notifications:${currentUser.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'notifications',
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        // Add new notification to list
                        const notificationsList = document.getElementById('notificationsList');
                        const notificationCard = createNotificationElement(payload.new);
                        
                        if (notificationsList.children[0]?.classList.contains('empty-state')) {
                            notificationsList.innerHTML = '';
                        }
                        
                        notificationsList.insertBefore(notificationCard, notificationsList.firstChild);
                        
                        // Show browser notification
                        if (Notification.permission === 'granted') {
                            new Notification(payload.new.title, {
                                body: payload.new.message,
                                icon: '/icon.png'
                            });
                        }
                    }
                )
                .subscribe();

            return subscription;
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }

        // Initialize
        window.onload = async () => {
            await loadNotifications();
            await requestNotificationPermission();
            subscribeToNotifications();
        };
    </script>
</body>
</html>